# DrivenBet: Quer Apostar Quanto?

## 1. About

This is a backend application of a bet-managing system that allows a betting house to automate its processes and day-to-day activities.

## 2. Deploy

click the link to access the application on your browser: [DrivenBet](https://drivenbet-quer-apostar-quanto.onrender.com)

## 3. Description

Once a sports event is registered into the system, while ongoing, the participants can place their bets on the final score. When the game is finalized, the scores are updated and the bets are processed, determining the winners, their earnings, and their final balance.

### Participant Management:

-   Entity: **Participant**
    ```typescript
    {
        id: number; // autogenerated, serialized ID number (ex. 1)
        createdAt: string; // timestamp that registers date and time of creation (ex: "2023-09-27T19:22:50.503Z")
        updatedAt: string; // timestamp that registers date and time when last updated (ex: "2023-09-27T19:22:50.503Z")
        name: string; // name of the participant (ex: "Ana")
        balance: number; // participant's current balance in cents (ex: 1000 or R$ 10,00)
    }
    ```

**POST** `/participants`

- Register new participants.
- list all registered participants.

-   **Request payload**: object containing participant's name and balance.
    ```tsx
    {
        name: string;
        balance: number;
    }
    ```
-   **Incoming payload**: object containing created participant.
    ```tsx
    {
        id: number;
        createdAt: string;
        updatedAt: string;
        name: string;
        balance: number;
    }
    ```

### Game Management:
-   Entity: **Game:**
    ```typescript
    {
        id: number;
        createdAt: string;
        updatedAt: string;
        homeTeamName: string;
        awayTeamName: string;
        homeTeamScore: number;
        awayTeamScore: number;
        isFinished: boolean;
    }
    ```

**POST** `/games`

- Create new games.
- List all games.

-   **Request payload**: object containing home team and away team names.
    ```tsx
    {
        homeTeamName: string; // (e.g.: Alaska Bears)
        awayTeamName: string; // (e.g.: Colorado Tigers)
    }
    ```
-   **Incoming payload**: object containing created game.
    ```tsx
    {
        id: number;
        createdAt: string;
        updatedAt: string;
        homeTeamName: string;
        awayTeamName: string;
        homeTeamScore: number;
        awayTeamScore: number;
        isFinished: boolean;
    }
    ```

**POST** `/games/:id`

- List game by its ID number.

-   **Incoming payload**: object containing created game with an array of objects containing its placed bets.
    ```tsx
    {
	id: number;
	createdAt: string;
	updatedAt: string;
	homeTeamName: string;
	awayTeamName: string;
	homeTeamScore: number;
	awayTeamScore: number;
	isFinished: boolean;
        bets: [
            {
                id: number;
                createdAt: string;
                updatedAt: string;
                homeTeamScore: number;
                awayTeamScore: number;
                amountBet: number;
                gameId: number; 
                participantId: number;
                status: string;
                amountWon: number || null;
            },
            {
                ...
            }
        ]
    }
    ```

**POST** `/games/:id/finish`

- Change status of the game between ongoing and finished.
- Updating a game's final score.
- Update bet statuses.
- Update participants' balances according to the results.

### Bet Management:
- Entity: **Bet**
    ```typescript
    {
        id: number;
        updatedAt: string;
        homeTeamScore: number;
        awayTeamScore: number;
        amountBet: number;
        gameId: number;
        participantId: number;
        status: string;
        amountWon: number || null;
    }
    ```

**POST** `/bets`

- Place bets on a chosen sports event.

-   **Request payload**: object containing home team and away team names.
    ```tsx
    {
        homeTeamScore: number;
        awayTeamScore: number;
        amountBet: number;
        gameId: number;
        participantId: number;
    }
    ```
-   **Incoming payload**: object containing created game.
    ```tsx
    {
        id: number;
        createdAt: string;
        updatedAt: string;
        homeTeamScore: number;
        awayTeamScore: number;
        amountBet: number;
        gameId: number;
        participantId: number;
        status: string;
        amountWon: number || null;
    }
    ```

### Validations and Security:
- Validate and sanitize request payload to ensure data integrity.
- Run integration tests to ensure the proper functioning of routes.
- Detailed coverage report.

## 3. Technologies

- JavaScript + TypeScript
- Node + Express
- Prisma (ORM)
- PostgreSQL
- Jest + Supertest

## 4. How To Run The Application:

You can operate on databases for different environments, but it is necessary to populate the correct env variables for each environment first.
1. Before running migrations, make sure you have a PostgreSQL database running based on the **.env.example** file for each environment.
2. Create the environment variables in their respective .env files:
    - .env: `DATABASE_URL=postgres://USERNAME:PASSWROD@localhost:5432/NAME-OF-DATABASE`

    - .env.test: `DATABASE_URL=postgres://USERNAME:PASSWORD@localhost:5432/NAME-OF-DATABASE-TEST`

3. In the terminal, run the command to install all dependencies and configure prisma:
    ```bash
    $ npm run pre:build
    ```
4. Run the command for the TypeScript configuration.
    ```bash
    $ npm run pre:build
    ```
5. Migrate for test environment:
    ```bash
    $ npm run dev:migration:run
    ```
6. Migrate for test environment:
    ```bash
    $ npm run test:migration:run
    ```
7. The application will be running on open terminal:
    ```bash
    $ npm run dev
    ```

## 4. How To Run Tests:

- In the terminal, run the command for all testing suites:
    ```bash
    $ npm run test
    ```
- In the terminal, run the command for coverage report:
    ```bash
    $ npm run test:coverage
    ```
- In the terminal, run the command for a detailed test report:
    ```bash
    $ npm run test:report
    ```
